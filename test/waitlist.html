<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Waitlist Tester (localhost:5000)</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        margin: 24px;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 16px;
        max-width: 980px;
      }
      label {
        display: block;
        font-size: 12px;
        color: #444;
        margin-bottom: 6px;
      }
      input,
      select {
        width: 340px;
        max-width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      button {
        padding: 10px 14px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
      }
      button.primary {
        border-color: #111;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .muted {
        color: #666;
        font-size: 12px;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: #0b1020;
        color: #e8e8e8;
        padding: 12px;
        border-radius: 10px;
        overflow: auto;
        min-height: 220px;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #ddd;
      }
      .pill.ok {
        border-color: #0a7;
        color: #0a7;
      }
      .pill.err {
        border-color: #c33;
        color: #c33;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      code {
        background: #f4f4f4;
        padding: 1px 6px;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <h1>Waitlist API Tester</h1>
    <p class="muted">
      Targets <code>http://localhost:5000</code> by default. If you open this
      via <code>file://</code> and hit CORS issues, serve it with any static
      server (or enable CORS on your Express app).
    </p>

    <div class="card">
      <div class="row">
        <div>
          <label for="baseUrl">Base URL</label>
          <input id="baseUrl" value="http://localhost:5000" />
          <div class="muted">
            Waitlist base path: <code>/api/waitlist</code>
          </div>
        </div>

        <div>
          <label for="email">Email</label>
          <input id="email" placeholder="you@example.com" />
        </div>

        <div>
          <label for="discordName">Discord name</label>
          <input id="discordName" placeholder="myname#1234 or myname" />
        </div>

        <div>
          <label for="adminToken">Admin token (optional)</label>
          <input
            id="adminToken"
            placeholder="If your AuthLevel.ADMIN uses a header token, paste it here"
          />
          <div class="muted">
            This UI will send
            <code>Authorization: Bearer &lt;token&gt;</code> when provided.
          </div>
        </div>

        <div>
          <label for="entryId">Entry ID (for GET/DELETE by id)</label>
          <input id="entryId" placeholder="e.g. 123" inputmode="numeric" />
        </div>
      </div>

      <div style="height: 12px"></div>

      <div class="row">
        <button class="primary" id="createBtn">
          POST /api/waitlist (Create)
        </button>
        <button id="getAllBtn">GET /api/waitlist (Admin)</button>
        <button id="statsBtn">GET /api/waitlist/stats (Admin)</button>
        <button id="getByIdBtn">GET /api/waitlist/:id (Admin)</button>
        <button id="deleteByIdBtn">DELETE /api/waitlist/:id (Admin)</button>
        <button id="clearBtn">Clear Output</button>
      </div>

      <div style="height: 12px"></div>

      <div class="grid">
        <div>
          <div
            class="row"
            style="align-items: center; justify-content: space-between"
          >
            <strong>Response</strong>
            <span id="statusPill" class="pill">idle</span>
          </div>
          <pre id="output">{}</pre>
        </div>

        <div>
          <strong>Notes</strong>
          <ul class="muted">
            <li>
              <strong>Create</strong> is public: <code>POST /api/waitlist</code>
            </li>
            <li>
              Admin routes: <code>GET /api/waitlist</code>, <code>/stats</code>,
              <code>/:id</code>, <code>DELETE /:id</code>
            </li>
            <li>
              Your controller returns <code>success</code> in most places, but
              in the non-autoInvite branch it returns
              <code>sucess</code> (typo). This UI shows raw JSON so you can see
              it.
            </li>
            <li>
              If you get CORS errors, enable CORS for your dev origin (or open
              this from a small local web server).
            </li>
          </ul>
        </div>
      </div>
    </div>

    <script>
      const els = {
        baseUrl: document.getElementById("baseUrl"),
        email: document.getElementById("email"),
        discordName: document.getElementById("discordName"),
        adminToken: document.getElementById("adminToken"),
        entryId: document.getElementById("entryId"),

        createBtn: document.getElementById("createBtn"),
        getAllBtn: document.getElementById("getAllBtn"),
        statsBtn: document.getElementById("statsBtn"),
        getByIdBtn: document.getElementById("getByIdBtn"),
        deleteByIdBtn: document.getElementById("deleteByIdBtn"),
        clearBtn: document.getElementById("clearBtn"),

        output: document.getElementById("output"),
        statusPill: document.getElementById("statusPill"),
      };

      function setStatus(ok, text) {
        els.statusPill.classList.remove("ok", "err");
        if (ok === true) els.statusPill.classList.add("ok");
        if (ok === false) els.statusPill.classList.add("err");
        els.statusPill.textContent = text;
      }

      function pretty(obj) {
        try {
          return JSON.stringify(obj, null, 2);
        } catch {
          return String(obj);
        }
      }

      function base() {
        return (els.baseUrl.value || "http://localhost:5000").replace(
          /\/+$/,
          ""
        );
      }

      function headers() {
        const h = { "Content-Type": "application/json" };
        const token = (els.adminToken.value || "").trim();
        if (token) h["Authorization"] = `Bearer ${token}`;
        return h;
      }

      function setBusy(b) {
        els.createBtn.disabled = b;
        els.getAllBtn.disabled = b;
        els.statsBtn.disabled = b;
        els.getByIdBtn.disabled = b;
        els.deleteByIdBtn.disabled = b;
      }

      async function request(method, path, body) {
        const url = base() + path;
        const init = { method, headers: headers() };
        if (body !== undefined) init.body = JSON.stringify(body);

        const startedAt = performance.now();
        let res, raw;

        setStatus(null, "sending...");
        try {
          res = await fetch(url, init);
          raw = await res.text();
        } catch (e) {
          setStatus(false, "network error");
          els.output.textContent =
            "Network error (likely CORS or server down).\n\n" + String(e);
          throw e;
        }

        const ms = Math.round(performance.now() - startedAt);

        let parsed;
        try {
          parsed = raw ? JSON.parse(raw) : null;
        } catch {
          parsed = raw;
        }

        setStatus(res.ok, `${res.status} ${res.statusText} â€¢ ${ms}ms`);

        els.output.textContent = pretty({
          request: {
            method,
            url,
            body: body ?? null,
            headers: Object.keys(headers()),
          },
          response: {
            status: res.status,
            statusText: res.statusText,
            ok: res.ok,
            body: parsed,
          },
        });

        if (res.ok && parsed && parsed.data && parsed.data.redirectUrl) {
          const full = base() + parsed.data.redirectUrl;
          els.output.textContent += "\n\nredirectUrl (full):\n" + full + "\n";
        }

        return { res, parsed };
      }

      els.clearBtn.addEventListener("click", () => {
        els.output.textContent = "{}";
        setStatus(null, "idle");
      });

      els.createBtn.addEventListener("click", async () => {
        const email = els.email.value.trim();
        const discordName = els.discordName.value.trim();
        setBusy(true);
        try {
          await request("POST", "/api/waitlist", { email, discordName });
        } finally {
          setBusy(false);
        }
      });

      els.getAllBtn.addEventListener("click", async () => {
        setBusy(true);
        try {
          await request("GET", "/api/waitlist");
        } finally {
          setBusy(false);
        }
      });

      els.statsBtn.addEventListener("click", async () => {
        setBusy(true);
        try {
          await request("GET", "/api/waitlist/stats");
        } finally {
          setBusy(false);
        }
      });

      els.getByIdBtn.addEventListener("click", async () => {
        const id = (els.entryId.value || "").trim();
        if (!id) {
          setStatus(false, "missing id");
          els.output.textContent = pretty({
            error: "Please enter an Entry ID first.",
          });
          return;
        }
        setBusy(true);
        try {
          await request("GET", `/api/waitlist/${encodeURIComponent(id)}`);
        } finally {
          setBusy(false);
        }
      });

      els.deleteByIdBtn.addEventListener("click", async () => {
        const id = (els.entryId.value || "").trim();
        if (!id) {
          setStatus(false, "missing id");
          els.output.textContent = pretty({
            error: "Please enter an Entry ID first.",
          });
          return;
        }
        setBusy(true);
        try {
          await request("DELETE", `/api/waitlist/${encodeURIComponent(id)}`);
        } finally {
          setBusy(false);
        }
      });
    </script>
  </body>
</html>
