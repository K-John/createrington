import config from "@/config";
import { Client, GatewayIntentBits, Partials } from "discord.js";

const BOT_TOKEN = config.discord.bots.main.token;

/**
 * Main Discord bot client instance
 *
 * Configured with neccessary intents and partials:
 * - Guilds: Access to guild/server information
 * - GuildMembers: Access to member join/leave events and member data
 * - GuildMessages: Access to message events in guild channels
 * - MessageContent: Access to actual message content (privileged intent)
 * - DirectMessages: Access to direct messages event
 * - Channel partial: Allows handling of uncached DM channels
 */
export const mainBot = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMembers,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.DirectMessages,
  ],
  partials: [Partials.Channel],
});

mainBot.once("clientReady", () => {
  logger.info("Logged in as", mainBot.user?.tag);
});

/**
 * Gets the main Discord bot client instance
 *
 * Throws an erro if the client is not initialized yet (before login)
 *
 * @returns The Discord client instance
 * @throws Error if client is not ready
 */
export function getMainClient(): Client {
  if (!mainBot.isReady()) {
    throw Error("Discord client is not ready yet");
  }
  return mainBot;
}

/**
 * Ensures the main bot is logged in and ready
 *
 * Useful for utilities that may run before the bot has finished connecting
 *
 * @returns Promise resolving to the ready Discord client
 */
export async function ensureMainClientReady(): Promise<Client> {
  if (!mainBot.isReady()) {
    await mainBot.login(BOT_TOKEN);
    await new Promise<void>((resolve) =>
      mainBot.once("clientReady", () => resolve()),
    );
  }
  return mainBot;
}
